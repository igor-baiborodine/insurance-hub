# Insurance Hub System & Go Migration Analysis

## System Context

* [Diagram source PlantUML](/docs/c4-diagrams/context/insurance-hub-system-context-diagram.puml)
* [Generated diagram on www.plantuml.com](https://www.plantuml.com/plantuml/uml/ZPDFSzis4CNl_1HRdzoPsBhqr5CIHwdTsbEDfEIgWS2bY0f_sDsb77txOa69aLcbqni9BDxxOV7sFOiXwOElVdBH-hv6Q4Kw_dKs8_DwltFIzjkUaMoAWb7kRGgppfkeP-vOQk-siuTVxXQwzENbUHOC2r9UsZpeYMzotwbwnNiNEqCcW7SHvTWX998sLPKuyGYh8mi6E1s2sfcT5ZU9u2boJoPQXCT-MrKB94xnrkmopZku-RxxGLTkyj87K6983KYBuCO2DXuPkknhFBos2IoX4MGmiOPWOfRKRU-iGxw_-Rcg1ghRKMAJkt7fgKI3Ot2M4YCTd4M-snh66hYSrZiCwYxk2b7JUm_UDMYFrgDoZWQZ_JjeA0NukqzIZYNep35Wb09R9zkNdtnb92CknGlUpVoRtFx5X7hLJFVxQba-OJNmAN4kGOh6m-BJP_XjL85vp9YbOecnHc9uNByy3wP6J2QLf6T616tKfU_UD7kZBUcCRH7-qDzYU53UbH2Qe3VAYP4cKT2z1QM3g_KX822psI5iAUsHIkyC7wDjASNKCzWKGX-T7MYtAA-84SwDdx1iJTnl6iuE7_DNDZU2XJb_9iesQlxPZV6RFQo-3i_9mpxuT79I41UqYmglmi1dEMYo16l9-4WTfOp3kNQ298PSqmnGw_8DozxZ3ubUliwV_mD9ju4jkKuOf3K2DJOkOWPmLab9nISCTRAyESbbwK_dCFq0uQDFfv1tIEnOjFOQpJcDM6j2XYWVtmQbgfRepxCx7QilZ7g9oQ3AUKulnlJAm2ZXutgzM6KNzPY8Nup3AUt8_oA4NbziL9ejvwlrTRbpoXVzrZjkaGkSJP6p4cV5O5m4F1JLQOWlqd5T_NjkdqhaU1AujraZpBxMULSUOdoz9Phwklnb1hMAtwQbTDnustjjUceQf5A0_3-q9zdII9sQGoZay80yYSdO_L7zQVQdHkKznheF_Xy0)
* [Explanation of system context and flows](/docs/c4-diagrams/context/insurance-hub-system-context-analysis.md)

### Migration Notes

* None

## System Containers

* [Diagram source PlantUML](/docs/c4-diagrams/container/insurance-hub-container-diagram.puml)
* [Generated diagram on www.plantuml.com](https://www.plantuml.com/plantuml/uml/dLT1LoCv3hxdLsWvDFHx3RdiQKy30QPXcfriGZD7dk9I4WykkzPoGMVtxNzVo-KgAaN1qDnIjgNli_HPKdxXW3xKfPdyJLjbwe9W6qB5_vXEFJwTR7JOrgkQoIjd0zbmebmvhGnQiJdcK1Yzcix-VZoNfUyttwObSY0Vb-vdqGAr9NzIYVy9FsXReSSIJ5mDkuh0-R1raqdGmH1qvw7Gk95pQ-VXodBjqIg2h_KAbZiEL4ucXt2gWlCycPDdPuzmGpPyWOFdqwUoSX2NlZCnX2q19ri83fYC0TqThPpHIXC3sW8UDJt57sXsGIi-EVWycJIWzsUkjWNwtL5dUHzZqu5cYWUVuRyJ0813kFGfPWLyWbynq1FkqaPtpoEkC9h_GIkugoFZgXA-yUV9doo_ReMqjXj3nnLk2B2g8b4Csbcel7lKHTnCLvC4WOvWVesA8ka1qAQ1ZpvJM63kV43JiXAi6wqYMwp3FZ2G3Nu7bOlEKphG63YTNu6dVzV4WM7jNPauhFDj1Jq7OEOyGVBCv1-r8XxmYdZR-xmdvE8dB9jFuN6DZpZTO_OLRM68cmkBDTcGGvAoT_t7BGJtG1Os507Inijmf8JlUi3pjF0sz0rQt123ylICP_IQr4uP0hT-JL5klIRF8ooyAseL-ZIQbVVn25lg8sPJXG6DsuoXHKPsqqThLjv6cw5HjS503EA1M5Jm4fTXXKm5E0i5hIDW0Rusn6_47htQZgL0rj_cD4_Qb-X6CEjyYKR_Xuelq3Z5bQ7c6RjrpiGe4ToLPFV2twoyJu7DFRRE5A94fLnjGygtX4GHCp5aY17mmgawRVNWpzkrFe7VN33QxbFujP5sbbSfUkW87NkIR1NG8S0HdMnEli3y_98_Zp11tguS-gBFf5rxPnuO3N5NDDiwohNa9RsLaGZ4FFLZFukVxqJpXEOuw990VC2wjaem8bZO9NMcPi2H0KAihKkd7gZ9GLkNpZ4WB8Fpmu9qlchrMQmwJQRZ8czXiJW_krdAZyRyFIzTlEPdajqs7tj-RvpTkFEpdkUmVVjLPyzPOzbp-jZtF7SSDfwM__esfBqRw3OR1u-MCSLqz2xvwIR0_5m_mMcN_EOI5mPPFjD-3xZ_OA70W2bZcKvpMiWC9IKy_YTj_-9781zNyoJ0RNEEwqSFk7v0QICLgYt1R_APk3ocLnqyOIa5RsumHDHIzYvHQQD3yvfuPzNME-jg1kNAihPjRrbHU2Aoa0KhVFh8VxAdolaWmbqkqi--c5lIyWOXlrxdavp85kGPljx6qIc5GzlW0ELazuG7O06zNg_lrooTEls6XTJQf6ZSKBgMDfH3DBsvkzXBVIxxFjaWW-m3Aw-hCBpN2kr30tGMVqK032ICNiMQBUzwK68Et1b9gZkLvIePcGmm2wVudfFxVbLy3V7Ck5KFChTzAleHR5__8Ip8D0LfgokMXUzCCcC6yetYuTAufqayrewKN64U8bFrlxsTBwClEP1sdYUh6tmWJhEHGcCOWkiCfjVBt_y9dvwhaR0vRCSl2AuL2yFHybc33Ko7C1YMxj3eGdJR33mCJpfiXnmxunSZpyBLOjlDSS6zRfkBryUCX_t-vrraoNpCk9F01ysxzlWXyq6NctltGvCK5sifwIqRTyh8EasAFCwgW5c_5er8P9ZSbxFU8dDDMmGgJtNYJWRuPwKkBfQt1sDUnsHmIK5jYTiTA2YWDZpkKlwpzGjiKvNbkKcdRghrA6vRrkVrocWMlCEcCSyyoKi_119NcNK-_PhiPivoNRxJHzRTnwmxuNtKlbFUJzXF3hlUFwXrendjpJeBmgB9NEg_Jru7QgLzVNuso-HUY20llEsact0YAQcpZvJRCRTkXw7E2-_WDZzjVOodF7__fIEHgPJlxAqV_WzxsfzO6ZzoFZUpqHmDtsw_tNzp4JMlv0Ok5BgUU3NzFTCVKLzlIEdAWJJ9t3BVg0MZxWPzElTVkPodu3KzKd8_nd0yvS_3nbKfF8VpmwYdoIzaYxeq_mS0)
* [Explanation of system containers and flows](/docs/c4-diagrams/container/insurance-hub-container-analysis.md)

### Migration Notes

#### Data Stores

| Data Store                  | Java          | Go                 |
|-----------------------------|---------------|--------------------|
| Policy Database             | PostgreSQL    | PostgreSQL         |
| Document Database           | PostgreSQL    | PostgreSQL         |
| Product Database            | MongoDB       | PostgreSQL + JSONB |
| Payment Database            | PostgreSQL    | PostgreSQL         |
| Search & Analytics Database | Elasticsearch | Elasticsearch      |

<details>
<summary>Reasoning for using PostgreSQL with JSONB for storing insurance products</summary>

1. **Consolidation of Database Technologies**: Given that PostgreSQL is already used to store
   policies, payments, and documents-related metadata, moving `Product Database` to PostgreSQL with
   JSONB, we will consolidate our relational database needs to a single technology stack. This
   simplifies operations, reduces the learning curve for new team members, and streamlines tooling
   and monitoring.
2. **JSONB Capabilities**: PostgreSQL's `JSONB` data type provides excellent support for
   semi-structured data, offering schema flexibility similar to what MongoDB provides. You can store
   your product data, which might have varying attributes, in `JSONB` columns. Importantly, `JSONB`
   is stored in a decomposed binary format, allowing for efficient indexing and querying of data
   within the JSON document.
3. **ACID Compliance and Relational Features**: While providing document-like flexibility,
   PostgreSQL retains its strong relational database features, including ACID (Atomicity,
   Consistency, Isolation, Durability) properties, mature transaction support, and the ability to
   join JSONB data with other relational tables if needed. This hybrid approach gives us the best
   of both worlds.
4. **Performance Considerations**: For many use cases, PostgreSQL with JSONB can offer comparable or
   even competitive performance to MongoDB, particularly for querying JSON. While
   MongoDB is often lauded for its performance with large-scale, dynamic data, PostgreSQL's
   continuous improvements in JSONB handling have made it a strong contender for many NoSQL-like
   workloads.
5. **Go Ecosystem Support**: Go has robust and mature drivers and ORMs for PostgreSQL, making the
   integration straightforward.

</details>

#### External systems
   
| External System          | Java        | Go                |
|--------------------------|-------------|-------------------|
| Event streaming platform | Kafka       | Kafka             |
| Bank statements storage  | File system | MinIO             |
| Documents storage        | File system | MinIO             |
| Tariff rules storage     | File system | Tarantool         |
| PDF reports generator    | JSReports   | chromedp(library) |

<details>
<summary>Reasoning for using Tarantool for tariff rule scripts storage and execution</summary>

1. **Extreme Performance:** This is the most significant benefit. Tarantool is an in-memory database
   and application server. By rewriting the pricing rules in Lua and executing them as stored
   procedures, the calculations would occur at in-memory speeds, right next to the data. This will
   almost certainly be drastically faster than the current architecture's chain of
   `HTTP Request -> Service Logic -> File I/O -> Script Interpretation`.
2. **Superior Decoupling:** The pricing logic becomes a self-contained, language-agnostic component
   within Tarantool. The new component in Go becomes incredibly simple: its only job is to receive a request,
   call the appropriate Lua function in Tarantool with the necessary parameters, and return the
   result. We could update the pricing rules dynamically without ever redeploying the `pricing-service`.
3. **Centralized and Atomic Logic:** Managing business rules in a database is far more robust than
   managing script files. With Tarantool, we can update pricing rules transactionally, ensuring
   that the system is never in an inconsistent state. It creates a single source of truth for
   pricing.
4. **Future-Proofing:** By moving the logic into Tarantool, we make it accessible to _any_ service,
   regardless of the programming language. If we later add a new microservice in Python or Rust
   that needs to calculate a price, it can call the exact same Lua procedure in Tarantool that our
   Go service uses.

</details>

<details>
<summary>Reasoning for chromedp for generating PDF documents</summary>

1. **Architectural Simplification:** We eliminate the need for the external `JSReport` service. This
   means one less component to deploy, scale, monitor, and maintain, which reduces operational
   complexity and cost.
2. **High Fidelity Rendering:** Since we are using a real browser engine (Chrome's Blink), we get
   exceptionally high-quality rendering that supports modern HTML5, CSS3, and even JavaScript within
   the templates. Our existing templates are very likely to work with minimal to no changes.
3. **Self-Contained Service:** The `JSReport` service is replaced by a single, self-contained Go
   binary with no external runtime dependencies for PDF generation (though it does need access to a
   Chrome/Chromium executable on the same machine or in the same container).
4. **Performance:** We remove the network latency of the HTTP call to `JSReport`, which could lead
   to faster document generation.

</details>

#### External Exposure and Interservice Communication

Use gRPC for internal service communication while exposing select services via gRPC-gateway to
provide HTTP/OpenAPI functionality, combining the performance benefits of gRPC with the universal
compatibility of REST APIs.

<details>
<summary>Reasoning for using gRPC with gRPC-gateway</summary>

1. **Protocol Optimization**
   - **gRPC for internal communication**: provides superior performance, type safety, bidirectional
     streaming, and efficient binary serialization between your Go services
   - **HTTP/REST for external exposure**: ensures universal compatibility with web frontends, mobile
     apps, and third-party integrations

2. **Single API Definition** removes duplication and ensures consistency across protocols
   - Define APIs once in `.proto` files
   - Auto-generate GRPC server/client code
   - Auto-generate HTTP/JSON handlers
   - Auto-generate OpenAPI/Swagger documentation

3. **Performance Benefits**
   - Internal GRPC communication is ~7-10x faster than HTTP/JSON
   - Binary protocol reduces serialization overhead
   - HTTP/JSON translation only occurs at the edge where needed

4. **Typical Flow**

```
External Client (HTTP/JSON)
    └──> API Gateway (HTTP)
           └──> grpc-gateway (HTTP to gRPC)
                  └──> gRPC Service

Internal Microservices
    └──> Direct gRPC calls between each other
```

</details>


## System Container Components

1. **Agent-portal-gateway**

* [Diagram source PlantUML](/docs/c4-diagrams/component/agent-portal-gateway-component-diagram.puml)
* [Generated diagram on www.plantuml.com](//www.plantuml.com/plantuml/png/ZLN1SkCs3BthAz0ScdIcYIyzxMdT9DjkfzlnnDdTemScOOarHQeaPLVJwRyNfAI4YjmT-KI2UC0py22yzm5TQ6jTVAUCqAqag49e_BlLok7vhbIXQlUj9oUi2MJ2dR3rgj5e8kRM1wdLVdN_q-qccZv_-drLem_asBIxjtLZJSGqCNxXZyeqwB06hGo5hY6mBbIsA88Ack357wJ2CleTh8Dr6IqRzaGDls2WCtP5SGsFVtCQmxPjnmbh_mwUAm8oyZQolVQmT_RC9q0Z8V2Jj6VZWoEEMolXBB-Tb21Vz05s7F36D_WZN6sLAPdF1ak2TTDe9J0eQwxuwKjBTt_wU8hP3YuLHGA-UW6dbx3lG1dVEZI20EDVy7TNF-Ifi0tLRk30uTPyXMr_ZU4_PHIdmCPogYw3Rf9X8HYxcidawDwo32xHLtkBJcO17aRRGWREobPC6FIMfN0bk3qvlBSiWuiAyzJtV5q8jDnE7I7f49q773meB-o9NCU8Wfy3AaDkzxDjZKJNtPIzQ1bnGSiCWdyAuDyr3u3Bfi23FKJXZex9wUNr9avf-YVaEFAlpyyRsAPRfFO7XT35mre8QZWKQWtAyEp6IZdwgoNFLjPl3I4JSjJeD8spROZr9bCg4qlsr1lWCHbUYcPOp-c2GLJannpGOAWy10jSm8CgMqSodyIXrX3Ja9-dJrDoK3gG6uQ4hUEaVKZsd49ifcYT2bts-D7m8PLXP9K8dL0hYO7Wjw_FV3-IyN5i1PUA_rygIpwKSswf0q8hFeyTk4-tAQC74XeTCpvHzlx1kZCwEQKKSsBJECign_3_dwmvb-5b9qSjNjBdHNgzddDcb3gOo1WAP-kEe6rVygJ9UVjw9GsX8hb1q4-aUrYb6Wzd5IfbPf9cfwcOPvBReFSqgHId6A5llQUAIPzlnlQ621t3P24ca6bNrrhRimVhG999WVg-SSPlSCXZp5iD9uKPUE9ygO-VFGt4lTKd6drUcyB1_irNuhJk1T_wnPPNEKxgaUEkDn-Jv5DL1nblLq-FssVu7hxIVcl5aMAnPbJVBB0lmpZvrtbA7Py6lHHejj3Y9sRMxnbiligMuUOxR2bolhgMulATjHoNBwlB8BQ-xT451RtihYSgbG_a-ba4D18ubbFauyo-9oFRMly7)
* [Explanation of system containers and flows](/docs/c4-diagrams/component/agent-portal-gateway-component-analysis.md)

2. **Auth-service**
* [Diagram source PlantUML](/docs/c4-diagrams/component/auth-service-component-diagram.puml)
* [Generated diagram on www.plantuml.com](//www.plantuml.com/plantuml/png/XLF1Rjim3BtxAxXSrW9hSzbfftPjrwLeWIn9iMF0M8ojLPOqaKuQ3FltIRRZUiw0tIpolSSdwlcA1OFKbSdUQPkRMX6K8fu_JQS1zvU5bhBUr4mXTrR8ocNkggatQ1FdWaKPlPdUVBoOfzBpq-EqGXOAiRI-SPLtDd5yqi_uHLkF0Iimsf8SF84BKhei4os6eCU3qbWatDO5kAwbX2M5dSufoswY2upiiFxiQgim7Cum0jRS0jQRhle19aFYv1n-PG3mDkCClOwWHrTe2qarE6CeJ6BjIUV1sIWBYxlbQjIyU_MEYG7R9bdbdRRIM4rhWcGdwkiSHJjxEJaVpqrsVN0xhIWqDeTuc7UTDEi1TpZjtVHtYPslQ9KXXaW5umgTWzl23erMKSKMhPCya4hAQFZKne-z35qyV5zreySxY9tXv7ko55288Le0reNb1YBkXU9d7UM1wpmdvcrj_hkDP7GToBie_PnCB-8tQt7Xq6nWVZsemCmAXIssJcvfgsstWnJEW7dx384aQDhrUr0e2DlWgWHjJXjaElMYDcjKw8L2KkzWSDsMZcvcbJTKHNXpeLJjAusLTcHuyomETBATtEsrb2ScVcVPyi12rVhkLSuA5DfZazyYQiBS1K43zsrvakhpMNyy7rBL9dRdZgK8jFps2CSh9DA2J6COJL-EvEmz71jSQizPFBqvGAyRvi-QM7Zqb7tWcpYkLlFbDFqGKJHfDDHnqc_9K18_aHBNqKQCOJY-aEGbyKcoOQVnt-nHmcEwE3r6qGMuJMn77KpwAmKp1dryNbAmENJu8QXP-u9GyIXkNMGYvOgigYlp1m00)
* [Explanation of system containers and flows](/docs/c4-diagrams/component/auth-service-component-analysis.md)


* [Diagram source PlantUML](/docs/c4-diagrams/component/-component-diagram.puml)
* [Generated diagram on www.plantuml.com]()
* [Explanation of system containers and flows](/docs/c4-diagrams/component/-component-analysis.md)


### Migration Notes


TODO:

1. Define system architecture: modular monolith etc.
2. Define code source repo type: monorepo etc.
3. Define migration strategy: develop from scratch(green field) or develop along the existing system
4. Define migration sequence for system components
5. Define observability components
6. Define deployment environment: k8s